input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][service] == "tripr-app" {
    grok {
      match => { 
        "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{DATA:thread}\] %{LOGLEVEL:level}\s*\[%{DATA:correlation_id}\] %{DATA:logger} - %{GREEDYDATA:log_message}"
      }
    }
    
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss" ]
    }
    
    if [log_message] =~ /^Incoming request:/ {
      grok {
        match => {
          "log_message" => "Incoming request: %{WORD:http_method} %{URIPATH:endpoint} from IP: %{IP:client_ip} User-Agent: %{GREEDYDATA:user_agent}"
        }
      }
      mutate {
        add_tag => [ "access_log" ]
      }
    }
    
    if [log_message] =~ /^Request completed:/ {
      grok {
        match => {
          "log_message" => "Request completed: %{WORD:http_method} %{URIPATH:endpoint} - Status: %{NUMBER:status_code} Duration: %{NUMBER:duration}ms"
        }
      }
      mutate {
        add_tag => [ "access_log", "completed_request" ]
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "tripr-app-logs-%{+YYYY.MM.dd}"
  }
}
